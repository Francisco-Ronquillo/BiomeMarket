{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todos los Productos - biomeMarket</title>
    <link rel="stylesheet" href="{% static 'CSS/site.css' %}">
    <link rel="stylesheet" href="{% static 'CSS/all-products.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <a href="{% url 'productos:home' %}">
                    <img src="{% static 'img/logo.png' %}" alt="biomeMarket Logo">
                </a>
            </div>
            <div class="nav-search">
                <input type="text" placeholder="Buscar productos..." id="globalSearch" value="{{ request.GET.q|default:'' }}">
                <button class="search-btn">üîç</button>
            </div>
            <div class="nav-icons">
                {% if usuario_autenticado %}
                    <span class="user-greeting">{{ usuario.nombre }}</span>
                    <a href="{% url 'accounts:logout' %}" class="btn-login">Cerrar Sesi√≥n</a>
                {% else %}
                    <a href="{% url 'accounts:signin' %}" class="btn-login">Iniciar Sesi√≥n</a>
                    <a href="{% url 'accounts:signup' %}" class="btn-login">Registrarse</a>
                {% endif %}
                <a href="{% url 'productos:carrito' %}" class="icon">üõí
                    <span class="cart-count">{{ carrito.total_items|default:0 }}</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="products-container">
        <!-- Header -->
        <section class="products-header">
            <div class="container">
                <div class="header-content">
                    <div class="breadcrumbs">
                        <a href="{% url 'productos:home' %}">Inicio</a> > Todos los Productos
                    </div>
                </div>
                <div class="header-controls">
                    <div class="sort-controls">
                        <label for="sortSelect">Ordenar por:</label>
                        <select id="sortSelect" onchange="updateOrdering()">
                            <option value="nombre" {% if request.GET.ordering == 'nombre' or not request.GET.ordering %}selected{% endif %}>Nombre (A-Z)</option>
                            <option value="precio" {% if request.GET.ordering == 'precio' %}selected{% endif %}>Precio: Bajo a Alto</option>
                            <option value="-precio" {% if request.GET.ordering == '-precio' %}selected{% endif %}>Precio: Alto a Bajo</option>
                            <option value="peso" {% if request.GET.ordering == 'peso' %}selected{% endif %}>Peso: Bajo a Alto</option>
                            <option value="-peso" {% if request.GET.ordering == '-peso' %}selected{% endif %}>Peso: Alto a Bajo</option>
                            <option value="-fecha_creacion" {% if request.GET.ordering == '-fecha_creacion' %}selected{% endif %}>M√°s Nuevos</option>
                        </select>
                    </div>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="toggleView(this,'grid')">üü•</button>
                        <button class="view-btn" onclick="toggleView(this,'list')">üìã</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Form oculto -->
        <form method="GET" id="filterForm" style="display:none;">
            <input type="hidden" name="q" id="hiddenQ" value="{{ request.GET.q|default:'' }}">
            <input type="hidden" name="ordering" id="hiddenOrdering" value="{{ request.GET.ordering|default:'nombre' }}">
            <input type="hidden" name="categoria" id="hiddenCategoria" value="{{ request.GET.categoria|default:'' }}">
            <input type="hidden" name="precio_max" id="hiddenPrecioMax" value="{{ request.GET.precio_max|default:'100.00'|floatformat:2 }}">
        </form>

        <div class="main-content">
            <div class="container">
                <div class="layout-grid">
                    <!-- Sidebar Filtros -->
                    <aside class="filters-sidebar">
                        <div class="filter-section">
                            <h3>Categor√≠as</h3>
                            <ul class="filter-list">
                                {% for categoria in categorias %}
                                    <li>
                                        <label for="chk-categoria-{{ categoria.id|default:forloop.counter }}">
                                            <input type="checkbox"
                                                   id="chk-categoria-{{ categoria.id|default:forloop.counter }}"
                                                   value="{{ categoria.tipo }}"
                                                   name="categoria"
                                                   {% if categoria.tipo in selected_categorias %}checked{% endif %}
                                                   onchange="updateCategoriaFilter()">
                                            {{ categoria.nombre }} ({{ categoria.product_count }})
                                        </label>
                                    </li>
                                {% empty %}
                                    <li>No hay categor√≠as disponibles.</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="filter-section">
                            <h3>Rango de Precio</h3>
                            <div class="price-range">
                                <input type="range"
                                       id="priceRange"
                                       min="0"
                                       max="100"
                                       step="0.01"
                                       value="{% if request.GET.precio_max %}{{ request.GET.precio_max|floatformat:2 }}{% else %}100.00{% endif %}"
                                       onchange="updatePriceFilter()">
                                <span class="price-value">$0 - $<span id="priceMax">{% if request.GET.precio_max %}{{ request.GET.precio_max|floatformat:2 }}{% else %}100.00{% endif %}</span></span>
                            </div>
                        </div>
                        <div class="filter-section">
                            <h3>Caracter√≠sticas</h3>
                            <ul class="filter-list">
                                <li><label for="chk-organico"><input type="checkbox" id="chk-organico" value="organico" onchange="filterByFeatures()"> Org√°nico</label></li>
                                <li><label for="chk-recien"><input type="checkbox" id="chk-recien" value="recien" onchange="filterByFeatures()"> Reci√©n Cosechado (‚â§7 d√≠as)</label></li>
                                <li><label for="chk-oferta"><input type="checkbox" id="chk-oferta" value="oferta" onchange="filterByFeatures()"> En Oferta</label></li>
                            </ul>
                        </div>
                        <button class="clear-filters" onclick="clearAllFilters()">Limpiar Filtros</button>
                    </aside>

                    <!-- Productos -->
                    <main class="products-main">
                        <div class="products-grid" id="productsGrid">
                            {% for producto in page_obj %}
                                <div class="producto-card-container">
                                    <a href="{% url 'productos:detalle_producto' producto.id %}"
                                       class="producto-card-link {{ producto.categoria.tipo }}{% if producto.categoria.tipo in 'vegetal,frutas' %} organico{% endif %}{% if producto.precio < umbral_oferta %} oferta{% endif %}"
                                       data-product-id="{{ producto.id }}"
                                       data-price="{{ producto.precio }}"
                                       data-peso="{{ producto.peso|default:1.00 }}"
                                       data-categoria="{{ producto.categoria.tipo }}"
                                       data-fechacreacion="{{ producto.fecha_creacion|date:'Y-m-d' }}"
                                       data-stock="{{ producto.stock }}">

                                        {% if producto.categoria.tipo in 'vegetal,frutas' %}
                                            <div class="badge">Org√°nico</div>
                                        {% endif %}
                                        {% if producto.precio < umbral_oferta %}
                                            <div class="badge oferta">Oferta</div>
                                        {% endif %}
                                        {% if producto.stock <= 0 %}
                                            <div class="badge out-stock">Sin Stock</div>
                                        {% endif %}

                                        {% if producto.imagen %}
                                            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="producto-imagen" loading="lazy">
                                        {% else %}
                                            <img src="{% static 'img/default-producto.jpg' %}" alt="{{ producto.nombre }}" class="producto-imagen" loading="lazy">
                                        {% endif %}

                                        <div class="producto-info">
                                            <h3>{{ producto.nombre }}</h3>
                                            <p class="descripcion-breve">{{ producto.descripcion|truncatewords:10 }}</p>
                                            <div class="rating">({{ producto.stock }} disponibles)</div>
                                            {% if producto.peso %}
                                                <p class="price">${{ producto.precio|floatformat:2 }}/{{ producto.peso|floatformat:2 }}kg</p>
                                            {% else %}
                                                <p class="price">${{ producto.precio|floatformat:2 }}</p>
                                            {% endif %}
                                        </div>
                                    </a>

                                    <div class="producto-actions">
                                        {% if producto.stock > 0 %}
                                            <form method="post" action="{% url 'productos:carrito_ajax' %}" class="cart-form" style="display: contents;">
                                                {% csrf_token %}
                                                <input type="hidden" name="producto_id" value="{{ producto.id }}">
                                                <input type="hidden" name="action" value="agregar">
                                                <input type="hidden" name="cantidad" value="1">
                                                <button type="submit" class="btn-add-cart" data-producto-nombre="{{ producto.nombre }}">Agregar al Carrito</button>
                                            </form>
                                        {% else %}
                                            <button class="btn-out-stock" disabled>Sin Stock</button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% empty %}
                                <div class="no-results">
                                    <h3>No hay productos disponibles que coincidan con los filtros.</h3>
                                    <p>Prueba con otros filtros o <a href="{% url 'productos:home' %}">regresa al inicio</a>.</p>
                                </div>
                            {% endfor %}
                        </div>

                        {% if is_paginated %}
                            <div class="pagination">
                                {% if page_obj.has_previous %}
                                    <a href="#" class="page-btn" onclick="goToPage('{{ page_obj.previous_page_number }}')">Anterior</a>
                                {% endif %}
                                <span class="page-numbers">
                                    {% for num in page_obj.paginator.page_range %}
                                        {% if page_obj.number == num %}
                                            <button class="page-num active">{{ num }}</button>
                                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                            <button class="page-num" onclick="goToPage('{{ num }}')">{{ num }}</button>
                                        {% endif %}
                                    {% endfor %}
                                </span>
                                {% if page_obj.has_next %}
                                    <a href="#" class="page-btn" onclick="goToPage('{{ page_obj.next_page_number }}')">Siguiente</a>
                                {% endif %}
                            </div>
                        {% endif %}
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 biomeMarket. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
    const CARRITO_AJAX_URL = '{% url "productos:carrito_ajax" %}';

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            for (const c of document.cookie.split(';')) {
                const cookie = c.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue || '';
    }

    const hiddenQ = document.getElementById('hiddenQ');
    const hiddenOrdering = document.getElementById('hiddenOrdering');
    const hiddenCategoria = document.getElementById('hiddenCategoria');
    const hiddenPrecioMax = document.getElementById('hiddenPrecioMax');
    const productsMain = document.querySelector('.products-main');

    async function applyFilters(event=null, page=null) {
        if (event) event.preventDefault();
        const params = new URLSearchParams();
        params.set('q', hiddenQ.value);
        params.set('ordering', hiddenOrdering.value);
        params.set('categoria', hiddenCategoria.value);
        params.set('precio_max', hiddenPrecioMax.value);
        if (page) params.set('page', page);
        fetch(`${window.location.pathname}?${params.toString()}`, {
            headers: {'X-Requested-With':'XMLHttpRequest'}
        }).then(r => r.json()).then(data => {
            productsMain.innerHTML = data.html;
            initializeCartHandlers();
            filterByFeatures();
        }).catch(e => console.error(e));
    }

    let searchTimeout;
    globalSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            hiddenQ.value = this.value.trim();
            applyFilters();
        }, 300);
    });

    // Note: search handlers are attached inside DOMContentLoaded below to ensure elements exist

    function updateOrdering() {
        hiddenOrdering.value = document.getElementById('sortSelect').value;
        applyFilters();
    }

    function updateCategoriaFilter() {
        const checked = document.querySelectorAll('input[name="categoria"]:checked');
        hiddenCategoria.value = Array.from(checked).map(cb => cb.value.trim()).join(',');
        applyFilters();
    }

    function updatePriceFilter() {
        const range = document.getElementById('priceRange');
        const value = parseFloat(range.value).toFixed(2);
        document.getElementById('priceMax').textContent = value;
        hiddenPrecioMax.value = value;
        applyFilters();
    }

    function goToPage(p) { applyFilters(null, p); }

    function toggleView(btn, view) {
        const grid = document.getElementById('productsGrid');
        grid.classList.toggle('list-view', view === 'list');
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function filterByFeatures() {
        const features = {
            organico: document.getElementById('chk-organico')?.checked,
            recien: document.getElementById('chk-recien')?.checked,
            oferta: document.getElementById('chk-oferta')?.checked
        };
        const cards = document.querySelectorAll('.producto-card-link');
        cards.forEach(card => {
            let ok = true;
            if (features.organico && !card.classList.contains('organico')) ok = false;
            if (features.oferta && !card.classList.contains('oferta')) ok = false;
            if (features.recien) {
                const d = new Date(card.dataset.fechacreacion);
                const diff = (Date.now() - d.getTime()) / (1000*60*60*24);
                if (diff > 7) ok = false;
            }
            card.closest('.producto-card-container').style.display = ok ? 'block':'none';
        });
    }

    function clearAllFilters() {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        document.getElementById('priceRange').value = 100;
        document.getElementById('priceMax').textContent = '100.00';
        globalSearch.value = '';
        hiddenQ.value = '';
        hiddenOrdering.value = 'nombre';
        hiddenCategoria.value = '';
        hiddenPrecioMax.value = '100.00';
        document.getElementById('sortSelect').value = 'nombre';
        applyFilters();
    }

    function initializeCartHandlers() {
        document.querySelectorAll('.cart-form').forEach(form => {
            form.addEventListener('submit', e => {
                e.preventDefault();
                handleCartAction(form);
            }, { once:true });
        });
        document.querySelectorAll('.btn-add-cart').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                const form = btn.closest('form');
                if (form) handleCartAction(form);
            });
        });
    }

    async function handleCartAction(form) {
        const btn = form.querySelector('.btn-add-cart');
        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Agregando...';
        try {
            const fd = new FormData(form);
            fd.append('csrfmiddlewaretoken', getCookie('csrftoken'));
            const r = await fetch(CARRITO_AJAX_URL, {
                method:'POST',
                body: fd,
                headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':getCookie('csrftoken')}
            });
            const data = await r.json();
            if (data.success) {
                const cartCount = document.querySelector('.cart-count');
                if (cartCount) cartCount.textContent = data.total_items || 0;
                btn.textContent = '¬°Agregado!';
            } else {
                btn.textContent = 'Error';
            }
        } catch(e) {
            btn.textContent = 'Error';
        } finally {
            setTimeout(() => { btn.disabled = false; btn.textContent = original; }, 1500);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initializeCartHandlers();
        filterByFeatures();

        // Attach search button and Enter key handlers after DOM is ready
        const globalSearchEl = document.getElementById('globalSearch');
        const searchBtnEl = document.querySelector('.search-btn');

        if (searchBtnEl) {
            searchBtnEl.addEventListener('click', function(e){
                e.preventDefault();
                const q = (globalSearchEl && globalSearchEl.value) ? globalSearchEl.value.trim() : '';
                const params = new URLSearchParams(window.location.search);
                if (q) params.set('q', q); else params.delete('q');
                window.location.href = window.location.pathname + (params.toString() ? ('?' + params.toString()) : '');
            });
        }

        if (globalSearchEl) {
            // permitir focus al hacer clic en el contenedor (por si hay un overlay que capture clicks)
            const navSearchContainer = document.querySelector('.nav-search');
            if (navSearchContainer) {
                // asegurar tabindex para que sea focusable
                if (!globalSearchEl.hasAttribute('tabindex')) globalSearchEl.setAttribute('tabindex', '0');
                navSearchContainer.addEventListener('click', function(e){
                    // si el click viene del bot√≥n, no interferimos
                    if (e.target && e.target.classList && e.target.classList.contains('search-btn')) return;
                    globalSearchEl.focus();
                });
            }

            globalSearchEl.addEventListener('keydown', function(e){
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const q = (this.value || '').trim();
                    const params = new URLSearchParams(window.location.search);
                    if (q) params.set('q', q); else params.delete('q');
                    window.location.href = window.location.pathname + (params.toString() ? ('?' + params.toString()) : '');
                }
            });
        }
    });
    </script>
    <div id="bm-chatbot-root"></div>
    <script src="{% static 'JS/chatbot.js' %}"></script>
</body>
</html>
